---
# pass code_file var to this play
## ansible-playbook main.yml -e "code_file=XXXXXXXXXXXXX"


## Write out to the new file, of the same name_of_file + .md; create it if it doesn't exist
- name: "write output to {{ file_path }}/{{ md_code_file }}"
  lineinfile:
    path: "{{ file_path }}/{{ md_code_file }}"
    regexp: 'ansible generated flow for'
    insertafter: EOF
    line: "_ansible generated process flow wireframe for {{ md_code_file }}_  \n  "
    state: present
    create: yes
    mode: 0777



- name: "Add comment marker to {{ md_code_file }}"
  lineinfile:
    path: "{{ file_path }}/{{ md_code_file }}"
    insertbefore: BOF
    line: "# {{ md_code_file }}  \n"

- name: "Add comment marker to {{ md_code_file }}"
  lineinfile:
    path: "{{ file_path }}/{{ md_code_file }}"
    insertbefore: 'ansible generated process flow wireframe for {{ md_code_file }}'
    line: "--- \n  \n### Meta:  \n  "
# write out Comments to the file
- name: "Add meta to {{ md_code_file }}"
  lineinfile:
    path: "{{ file_path }}/{{ md_code_file }}"
    insertbefore: 'ansible generated process flow wireframe for {{ md_code_file }}'
    line: "{{ item | regex_findall('<meta(.+)>') | join('  \n') }}  \n"
  with_file: "{{code_file}}"

# write out Comment Blocks to the file
- name: "Add Comment Blocks to {{ md_code_file }}"
  lineinfile:
    path: "{{ file_path }}/{{ md_code_file }}"
    insertbefore: 'ansible generated process flow wireframe for {{ md_code_file }}'
    line: "--- \n  \n### Comment Blocks:  \n  "
- name: "Add comments to {{ md_code_file }}"
  lineinfile:
    path: "{{ file_path }}/{{ md_code_file }}"
    insertbefore: 'ansible generated process flow wireframe for {{ md_code_file }}'
    # (?:) non-capturing group
    # [^>]* capture anything that isn't >
    line: "  \n{{ item | regex_findall('(?:<!-\\W+|<!-\\W+\\n)([^>]*)(?:\\W+->|\\n\\W+->|\\W+\\n\\W+->)') | join('  \n') }}  \n  \n  "
  with_file: "{{code_file}}"
